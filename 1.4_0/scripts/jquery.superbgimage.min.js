 /**
 * --------------------------------------------------------------------
 * jQuery-Plugin SuperBGimage - Scaling Fullscreen Backgrounds and Slideshow using jQuery
 * Version: 1.0, 29.08.2009
 *
 * by Andreas Eberhard, andreas.eberhard@gmail.com
 *                      http://dev.andreaseberhard.de/projects/superbgimage/
 *
 * Copyright (c) 2009 Andreas Eberhard
 * licensed under a Creative Commons Attribution 3.0
 *
 *  Inspired by 
 *	  Supersized - Fullscreen Slideshow jQuery Plugin
 *    http://buildinternet.com/project/supersized/
 *	  By Sam Dunn (www.buildinternet.com // www.onemightyroar.com)
 * --------------------------------------------------------------------
 * License:
 * http://creativecommons.org/licenses/by/3.0/
 * http://creativecommons.org/licenses/by/3.0/deed.de
 *
 * You are free:
 *       * to Share - to copy, distribute and transmit the work
 *       * to Remix - to adapt the work
 *
 * Under the following conditions:
 *       * Attribution. You must attribute the work in the manner specified
 *         by the author or licensor (but not in any way that suggests that
 *         they endorse you or your use of the work).
 * --------------------------------------------------------------------
 * Changelog:
 *    29.08.2009 initial Version 1.0
 *    22.10.2013 changed superbgCalcSize function to do different image scaling,
 *               depending on the new option 'scaletofit'
 *               Done by: Andreas Meyer (meyer@humanmachine.de)
  * --------------------------------------------------------------------
 
 */
(function($) {
    jQuery.fn.superbgimage = function(loadingoptions) {
		// if (console && console.log) console.log("call superbgimage");
        var options = $.extend($.fn.superbgimage.defaults, $.fn.superbgimage.options, loadingoptions);
        $.superbg_inAnimation = false;
        $.superbg_slideshowActive = false;
        $.superbg_imgIndex = 1;
        $.superbg_imgActual = 1;
        $.superbg_imgLast = -1;
        $.superbg_imgSlide = 0;
        $.superbg_interval = 0;
		$.superbg_bordermove = 0;	//边框移动
        $.superbg_preload = 0;
        $.superbg_direction = 0;
        $.superbg_max_randomtrans = 7;
        $.superbg_lasttrans = -1;
        $.superbg_isIE6 = false;
        $.superbg_firstLoaded = false;
        $.superbg_saveId = $(this).attr('id');
        if ($('#' + options.id).length === 0) {
            $('body').prepend('<div id="' + options.id + '" style="display:none;"></div>');
        } else {
            $('body').prepend($('#' + options.id));
        }
        $('#' + options.id).css('display', 'none').css('overflow', 'hidden').css('z-index', options.z_index);
        if (options.inlineMode === 0) {
            $('#' + options.id).css('position', 'fixed').css('width', '100%').css('height', '100%').css('top', 0).css('left', 0);
        }
        if (options.reload) {
            $('#' + options.id + ' img,video').remove();
        }
        $('#' + options.id + ' img,video').hide().css('position', 'absolute');
        $('#' + options.id).children('img').each(function() {
            $(this).attr('rel', $.superbg_imgIndex++);
            if (!options.showtitle) {
                $(this).attr('title', '');
            }
        });
		$('#' + options.id).children('video').each(function() {
            $(this).attr('rel', $.superbg_imgIndex++);
            if (!options.showtitle) {
                $(this).attr('title', '');
            }
        });
        $(this).children('a').each(function() {
            $(this).attr('rel', $.superbg_imgIndex++).click(function() {
                $(this).superbgShowImage();
                return false;
            }).addClass('preload');
        });
        $.superbg_imgIndex--;
        $(window).bind('load', function() {
            $(this).superbgLoad();
        });
        $(window).bind('resize', function() {
            $(this).superbgResize();
        });
        $.superbg_isIE6 = /msie|MSIE 6/.test(navigator.userAgent);
        if ($.superbg_isIE6 && (options.inlineMode === 0)) {
            $('#' + options.id).css('position', 'absolute').width($(window).width()).height($(window).height());
            $(window).bind('scroll', function() {
                $(this).superbgScrollIE6();
            });
        }
        if (options.reload) {
            $(this).superbgLoad();
        }
        return this;
    };
    jQuery.fn.superbgScrollIE6 = function() {
        var options = $.extend($.fn.superbgimage.defaults, $.fn.superbgimage.options);
        $('#' + options.id).css('top', document.documentElement.scrollTop + 'px');
    };
    jQuery.fn.superbgLoad = function() {
		// if (console && console.log) console.log("call superbgLoad");
        var options = $.extend($.fn.superbgimage.defaults, $.fn.superbgimage.options);
        if ( ( ($('#' + options.id).children('img').length > 0)||($('#' + options.id).children('video').length > 0)) || ($('#' + $.superbg_saveId).children('a').length > 0)) {
            $('#' + options.id).show();
        }
        if ((typeof options.showimage != 'undefined') && (options.showimage >= 0)) {
            $.superbg_imgActual = options.showimage;
        }
        if (options.randomimage === 1) {
            $.superbg_imgActual = (1 + parseInt(Math.random() * ($.superbg_imgIndex - 1 + 1), 10));
        }
        $(this).superbgShowImage($.superbg_imgActual);
    };
    jQuery.fn.superbgimagePreload = function() {
		// if (console && console.log) console.log("call superbgimagePreload");
		//alert(this);
        var options = $.extend($.fn.superbgimage.defaults, $.fn.superbgimage.options);
		if ($.superbg_preload !== 0) {
			clearInterval($.superbg_preload);
		}
        if (!$.superbg_firstLoaded && ($('#' + $.superbg_saveId).children('a').length > 0)) {
            $.superbg_preload = setInterval("$(this).superbgimagePreload()", 111);
            return;
        }
        $('#' + $.superbg_saveId).children('a.preload:first').each(function() {
            var imgrel = $(this).attr('rel');
            var imgtitle = $(this).attr('title');
            var img = new Image();
            $(img).load(function() {
                $(this).css('position', 'absolute').hide();
                if ($('#' + options.id).children('*' + "[rel='" + imgrel + "']").length === 0) {
                    $(this).attr('rel', imgrel);
                    if (options.showtitle === 1) {
                        $(this).attr('title', imgtitle);
                    }
                    $('#' + options.id).prepend(this);	//插入图片
                }
                img.onload = function() {
                };
            }).error(function() {
                img.onerror = function() {
                };
            }).attr('src', $(this).attr('href'));
            $.superbg_preload = setInterval("$(this).superbgimagePreload()", 111);
        }).removeClass('preload');
    };
    jQuery.fn.startSlideShow = function() {
		// if (console && console.log) console.log("call startSlideShow");
        var options = $.extend($.fn.superbgimage.defaults, $.fn.superbgimage.options);
        $.superbg_imgSlide = $.superbg_imgActual;
        if ($.superbg_interval !== 0) {
            clearInterval($.superbg_interval);
        }
		if($('#' + $.superbg_saveId + ' a' + "[rel='" + $.superbg_imgActual + "']").attr('isvideo')!=='true'){
			//图片
			$.superbg_interval = setInterval("$(this).nextSlide()", options.slide_interval);
		} else {
			//视频 延迟修正
			if(
				$('#' + options.id).children('video' + "[rel='" + $.superbg_imgActual + "']").length > 0
				&& $.isNumeric( $('#' + options.id).children('video' + "[rel='" + $.superbg_imgActual + "']")[0].duration )
				&& options.slide_interval <= $('#' + options.id).children('video' + "[rel='" + $.superbg_imgActual + "']")[0].duration*1000		){
				$.superbg_interval = setInterval("$(this).nextSlide()", Math.round($('#' + options.id).children('video' + "[rel='" + $.superbg_imgActual + "']")[0].duration*1000));
			}
			else
			{
				$.superbg_interval = setInterval("$(this).nextSlide()", options.slide_interval);
			}
		}
        $.superbg_slideshowActive = true;
        return false;
    };
    jQuery.fn.stopSlideShow = function() {
		// if (console && console.log) console.log("call stopSlideShow");
        var options = $.extend($.fn.superbgimage.defaults, $.fn.superbgimage.options);
        clearInterval($.superbg_interval);
        $.superbg_slideshowActive = false;
        return false;
    };
    jQuery.fn.nextSlide = function() {
		// if (console && console.log) console.log("call nextSlide");
        var options = $.extend($.fn.superbgimage.defaults, $.fn.superbgimage.options);
        if ($.superbg_inAnimation)
            return false;
			
		clearInterval($.superbg_bordermove);	//
		$.superbg_bordermove = 0;	//避免切换时坐标错乱
		
		afa_autoup = options.scaletofit ===2 && (options.initdirection===0 || options.initdirection===1)? true : false;
		afa_autodown = options.scaletofit ===2 && (options.initdirection===2 || options.initdirection===3)? true : false;
		afa_autoleft = options.scaletofit ===2 && (options.initdirection===0 || options.initdirection===2)? true : false;
		afa_autoright = options.scaletofit ===2 && (options.initdirection===1 || options.initdirection===3)? true : false;
		
        if ($.superbg_slideshowActive) {
            clearInterval($.superbg_preload);
        }
        $.superbg_direction = 0;
        
		//$.superbg_imgSlide++;
		var newlength = $('#thumbs1 a.preload,a.auto').length;
		$.superbg_imgSlide = $('#thumbs1 a.preload,a.auto')[($.superbg_imgSlide>=newlength) ? 0 : $.superbg_imgSlide].rel;
		
		// console.log("afa nextSlide $.superbg_imgSlide=" + $.superbg_imgSlide);
        if ($.superbg_imgSlide > $.superbg_imgIndex) {
            $.superbg_imgSlide = $('#thumbs1 a.preload,a.auto')[0].rel;	//	$.superbg_imgSlide = 1;
        }
        // if (options.randomimage === 1) {
            // $.superbg_imgSlide = (1 + parseInt(Math.random() * ($.superbg_imgIndex - 1 + 1), 10));
            // while ($.superbg_imgSlide === $.superbg_imgLast) {
                // $.superbg_imgSlide = (1 + parseInt(Math.random() * ($.superbg_imgIndex - 1 + 1), 10));
            // }
        // }
		if (options.randomimage === 1) {
            $.superbg_imgSlide = $('#thumbs1 a.preload,a.auto')[parseInt(Math.random() * newlength, 10)].rel;
            while ($.superbg_imgSlide === $.superbg_imgLast) {
                $.superbg_imgSlide = $('#thumbs1 a.preload,a.auto')[parseInt(Math.random() * newlength, 10)].rel;
            }
        }
        $.superbg_imgActual = $.superbg_imgSlide;	//需要做一下转换：
		
		// for(var i=1;i<=$.superbg_imgActual;i++){
			//if($('#thumbs1 a' + "[rel='" + i + "']").hasClass('moved')){	//这个CSS Selector频繁调用，a元素很多，有性能问题
			// if($('#thumbs1 a:nth-of-type(' + i + ")")..hasClass('moved')){	//http://www.w3school.com.cn/cssref/selector_nth-of-type.asp
				// $.superbg_imgSlide--;
				// if($.superbg_imgSlide<1){
					// $.superbg_imgSlide = 1
					// break;
				// }
			// }
		// }
		// if($.superbg_imgSlide - 1 >= $('#thumbs1 a.preload,a.auto').length){
			// $.superbg_imgSlide = 1
		// }
		// $.superbg_imgActual = ($('#thumbs1 a.preload,a.auto')[$.superbg_imgSlide - 1].rel);
        return $(this).superbgShowImage($.superbg_imgActual);
    };
    jQuery.fn.prevSlide = function() {
		// if (console && console.log) console.log("call prevSlide");
        var options = $.extend($.fn.superbgimage.defaults, $.fn.superbgimage.options);
        if ($.superbg_inAnimation)
            return false;
				
		clearInterval($.superbg_bordermove);	//
		$.superbg_bordermove = 0;	//避免切换时坐标错乱
		//初始移动方向：先下或先右
		afa_autoup = options.scaletofit ===2 && (options.initdirection===0 || options.initdirection===1)? true : false;
		afa_autodown = options.scaletofit ===2 && (options.initdirection===2 || options.initdirection===3)? true : false;
		afa_autoleft = options.scaletofit ===2 && (options.initdirection===0 || options.initdirection===2)? true : false;
		afa_autoright = options.scaletofit ===2 && (options.initdirection===1 || options.initdirection===3)? true : false;
		
        $.superbg_direction = 1;
        //$.superbg_imgSlide--;
		var newlength = $('#thumbs1 a.preload,a.auto').length;
		$.superbg_imgSlide = $('#thumbs1 a.preload,a.auto')[($.superbg_imgSlide<=1) ? (newlength - 1) : ($.superbg_imgSlide-2)].rel;
		
        if ($.superbg_imgSlide < 1) {
            $.superbg_imgSlide = $('#thumbs1 a.preload,a.auto')[newlength - 1].rel;	//	$.superbg_imgSlide = $.superbg_imgIndex;
        }
        // if (options.randomimage === 1) {
            // $.superbg_imgSlide = (1 + parseInt(Math.random() * ($.superbg_imgIndex - 1 + 1), 10));
            // while ($.superbg_imgSlide === $.superbg_imgLast) {
                // $.superbg_imgSlide = (1 + parseInt(Math.random() * ($.superbg_imgIndex - 1 + 1), 10));
            // }
        // }
		if (options.randomimage === 1) {
            $.superbg_imgSlide = $('#thumbs1 a.preload,a.auto')[parseInt(Math.random() * newlength, 10)].rel;
            while ($.superbg_imgSlide === $.superbg_imgLast) {
                $.superbg_imgSlide = $('#thumbs1 a.preload,a.auto')[parseInt(Math.random() * newlength, 10)].rel;
            }
        }
        $.superbg_imgActual = $.superbg_imgSlide;	//需要做一下转换：
		/* for(var i=1;i<$.superbg_imgActual;i++){
			if($('#thumbs1 a' + "[rel='" + i + "']").hasClass('moved')){
				$.superbg_imgSlide--;
				if($.superbg_imgSlide<1){
					$.superbg_imgSlide = $('#thumbs1 a.preload,a.auto').length
					break;
				}
			}
		}
		if($.superbg_imgSlide - 1 >= $('#thumbs1 a.preload,a.auto').length){
			$.superbg_imgSlide = $('#thumbs1 a.preload,a.auto').length
		} */
		$.superbg_imgActual = ($('#thumbs1 a.preload,a.auto')[$.superbg_imgSlide - 1].rel);
        return $(this).superbgShowImage($.superbg_imgActual);
    };
	jQuery.fn.afa_moveto = function(dest) {
		//当前画面
		if( ($('#thumbs1 a' + "[rel='" + $.superbg_imgActual + "']").attr('class')) != "moved") {
			//$.superbg_imgIndex--;
			// $.superbg_imgSlide--;
			$('#thumbs1 a' + "[rel='" + $.superbg_imgActual + "']").attr('class','moved');
		}
		var thisfilename = $('#thumbs1 a' + "[rel='" + $.superbg_imgActual + "']").attr('title');
		alert("LocalGalleryViewerExtension_cmd?" + thisfilename + "?" + dest);
    };
    jQuery.fn.superbgResize = function() {
		// if (console && console.log) console.log("call superbgResize");
		//var debugtime1 = new Date().getTime();
        var options = $.extend($.fn.superbgimage.defaults, $.fn.superbgimage.options);
        var thisimg = $('#' + options.id + ' img.activeslide,video.activeslide');
		var thisimg1 = $(thisimg);
        var dimensions = $(this).superbgCalcSize(thisimg1.width(), thisimg1.height());
		if(dimensions == null){
			return;
		}
        var newwidth = dimensions[0];
        var newheight = dimensions[1];
        var newleft = dimensions[2];
        var newtop = dimensions[3];
        //thisimg1.css('width', newwidth + 'px');
        //thisimg1.css('height', newheight + 'px');
		var cssprop = {	'width' : newwidth + 'px',
						'height' : newheight + 'px',
						'left' : newleft + 'px',
						'top' : (options.vertical_center === 1 ? (newtop + 'px') : '0px')
					};
        if ($.superbg_isIE6 && (options.inlineMode === 0)) {
            $('#' + options.id).width(newwidth).height(newheight);
            thisimg1.width(newwidth);
            thisimg1.height(newheight);
        }
        //thisimg1.css('left', newleft + 'px');
        //if (options.vertical_center === 1) {
            //thisimg1.css('top', newtop + 'px');
        //} else {
            //thisimg1.css('top', '0px');
        //}
		thisimg1.css(cssprop);
		//var debugtime2 = new Date().getTime();
		//// if (console && console.log) console.log(debugtime2 - debugtime1);
    };
    
    jQuery.fn.superbgCalcSize = function(imgw, imgh) {
		// if (console && console.log) console.log("call superbgCalcSize");
        var options = $.extend($.fn.superbgimage.defaults, $.fn.superbgimage.options);
		var window1 = $(window);
        var browserwidth = window1.width();
        var browserheight = window1.height();
        if (options.inlineMode === 1) {
            // browserwidth=$('#'+options.id).width();
            // browserheight=$('#'+options.id).height();
            browserwidth = imgw;
            browserheight = imgh;
        }
        var ratio = imgh / imgw;
        var newheight = 0;
        var newwidth = 0;
        if (options.scaletofit < 1) {
            if ((browserheight / browserwidth) < ratio) {	//图片比屏幕高
                newheight = browserheight;	//屏幕高度较小，用这个来缩小
                newwidth = Math.round(browserheight / ratio);
            } 
            else {
                newheight = Math.round(browserwidth * ratio);
                newwidth = browserwidth;
            }
        } 
        else {
            if ((browserheight / browserwidth) > ratio) {	//屏幕比图片高
                newheight = browserheight;	//屏幕高度较大，用这个来放大
                newwidth = Math.round(browserheight / ratio);
            } 
            else {
                newheight = Math.round(browserwidth * ratio);
                newwidth = browserwidth;
            }
        }
		newwidth *= afa_zoom;
		newheight *= afa_zoom;

		var newleft = isNaN(afa_xA) ? Math.round((browserwidth - newwidth) / 2) : afa_xA;
        var newtop = isNaN(afa_yA) ? Math.round((browserheight - newheight) / 2) : afa_yA;
		var now = new Date().getTime();
		if(afa_imageload){
			afa_oldtime = now;
			if( options.initposition === 1 )
			{
				newleft = 0;
				newtop = 0;
			}
			else if( options.initposition === 2 )
			{
				newleft = Math.round(browserwidth - newwidth);
				newtop = 0;
			}
			else if( options.initposition === 3 )
			{
				newleft = 0;
				newtop = Math.round(browserheight - newheight);
			}
			else if( options.initposition === 4 )
			{
				newleft = Math.round(browserwidth - newwidth);
				newtop = Math.round(browserheight - newheight);
			}
			else	//	初始位置，屏幕中央
			{	
				newleft = Math.round((browserwidth - newwidth) / 2);
				newtop = Math.round((browserheight - newheight) / 2);
			}
			afa_imageload = false;
		}
        var rcarr = [newwidth, newheight, newleft, newtop];
		var xC, yC;
		if(!afa_drag || options.scaletofit === 2){	//在屏幕边界则自动滚动
			var notmove = true;
			var speed1 = options.xspeed;//0.005;
			var speed2 = options.yspeed;//0.002;
			var e = window.event;	//这里获取到的坐标只是img里的鼠标相对位置，需要再加上img的left,top
			if( typeof(e) != 'undefined' ){
				if( e.type.indexOf('mouse')>=0 ) {	//并非每次都有事件，鼠标坐标需要持久化
					if (typeof e.pageX === 'number') {
						afa_borderX = e.pageX;
						afa_borderY = e.pageY;
					}
				}
			}
			if(options.scaletofit != 2 || afa_notmove){
				if(afa_borderX>browserwidth*0.925-10 && newleft+newwidth>browserwidth){
					newleft -= speed1*newwidth;	//往左移动
					notmove = false;
				}
				if(afa_borderX<10+browserwidth*0.075 && newleft<0){
					newleft += speed1*newwidth;	//往右移动
					notmove = false;
				}
				if(afa_borderY>browserheight*0.925-10 && newtop+newheight>browserheight){
					newtop -= speed1*newheight;	//往上移动
					notmove = false;
				}
				if(afa_borderY<8+browserheight*0.075 && newtop<0){
					newtop += speed1*newheight;	//往下移动
					notmove = false;
				}
			}
			else{
				//var now = afa_date.getTime();
				//// if (console && console.log) console.log("now=" + now + ", delta=" + (now - afa_oldtime));
				if(afa_autoleft){
					newleft -= speed2*2.0*(now - afa_oldtime)/(options.slide_interval + options.outspeed)*Math.abs(browserwidth - newwidth);	//往左移动
					notmove = false;
					if(newleft+newwidth<=browserwidth){
						afa_autoright = true;
						afa_autoleft = false;
					}
				}
				if(afa_autoright){
					newleft += speed2*2.0*(now - afa_oldtime)/(options.slide_interval + options.outspeed)*Math.abs(browserwidth - newwidth);	//往右移动
					notmove = false;
					if(newleft>=0){
						afa_autoright = false;
						afa_autoleft = true;
					}
				}
				
				if(afa_autoup){
					newtop -= speed2*2.0*(now - afa_oldtime)/(options.slide_interval + options.outspeed)*Math.abs(browserheight - newheight);	//往上移动
					notmove = false;
					if(newtop+newheight<=browserheight){
						afa_autodown = true;
						afa_autoup = false;
					}
				}
				if(afa_autodown){
					newtop += speed2*2.0*(now - afa_oldtime)/(options.slide_interval + options.outspeed)*Math.abs(browserheight - newheight);	//往下移动
					notmove = false;
					if(newtop>=0){
						afa_autodown = false;
						afa_autoup = true;
					}
				}
				afa_oldtime = now;
			}
			if(notmove ){//|| afa_notmove && options.scaletofit == 2){
				//if( $.superbg_bordermove != 0 ){
					clearInterval($.superbg_bordermove);
					$.superbg_bordermove = 0;
				//}
			} else {
				if( $.superbg_bordermove == 0 ){	//60fps 影响垂直同步
					$.superbg_bordermove = setInterval("$(this).superbgResize()", options.fpsinterval);//setInterval("$(this).superbgimageBorderMove()", 10);
				}
			}
		}
		if(afa_zoom!=1.0 || afa_zoom_old!=1.0){
			var e = window.event;	//这里获取到的坐标只是img里的鼠标相对位置，需要再加上img的left,top
			if( typeof(e) != 'undefined' ){
				if (typeof e.offsetX === 'number') {
					xC = e.offsetX;
					yC = e.offsetY;
				} else if (typeof e.layerX === 'number') {
					xC = e.layerX;
					yC = e.layerY;
				}
				var options = $.extend($.fn.superbgimage.defaults, $.fn.superbgimage.options);
				var thisimg = $($('#' + options.id + ' img.activeslide,video.activeslide'));
				xC += thisimg[0].offsetLeft;
				yC += thisimg[0].offsetTop;
				newleft = Math.round( xC * (1.0 - afa_zoom / afa_zoom_old) + afa_xA*afa_zoom/afa_zoom_old );
				newtop = Math.round( yC * (1.0 - afa_zoom / afa_zoom_old) + afa_yA*afa_zoom/afa_zoom_old );

				if(afa_drag){	//鼠标拖动
					clearInterval($.superbg_bordermove);
					$.superbg_bordermove = 0;
					if(!(newleft<0 && xC-afa_dragX<0 && newleft+newwidth<browserwidth || newleft>0 && newleft+newwidth>browserwidth && xC-afa_dragX>0))
						newleft += xC - afa_dragX;
					if(!(newtop<0 && yC-afa_dragY<0 && newtop+newheight<browserheight || newtop>0 && newtop+newheight>browserheight && yC-afa_dragY>0))
						newtop += yC - afa_dragY;
				}
			}
		}
		else if(afa_drag){	//鼠标拖动
			clearInterval($.superbg_bordermove);
			var e = window.event;	//这里获取到的坐标只是img里的鼠标相对位置，需要再加上img的left,top
			if( typeof(e) != 'undefined' ){
				$.superbg_bordermove = 0;
				if (typeof e.offsetX === 'number') {
					xC = e.offsetX;
					yC = e.offsetY;
				} else if (typeof e.layerX === 'number') {
					xC = e.layerX;
					yC = e.layerY;
				}
				var options = $.extend($.fn.superbgimage.defaults, $.fn.superbgimage.options);
				var thisimg = $($('#' + options.id + ' img.activeslide,video.activeslide'));
				if(thisimg.length < 1 || !($.isNumeric(thisimg[0].offsetLeft)) || !($.isNumeric(thisimg[0].offsetTop)) ){
					return null;
				}
				xC += thisimg[0].offsetLeft;
				yC += thisimg[0].offsetTop;
				if(!(newleft<0 && xC-afa_dragX<0 && newleft+newwidth<browserwidth || newleft>0 && newleft+newwidth>browserwidth && xC-afa_dragX>0))
					newleft += xC - afa_dragX;
				if(!(newtop<0 && yC-afa_dragY<0 && newtop+newheight<browserheight || newtop>0 && newtop+newheight>browserheight && yC-afa_dragY>0))
					newtop += yC - afa_dragY;
			}
		}
		
		afa_xA = isNaN(newleft) ? Math.round((browserwidth - newwidth) / 2) : newleft;
		afa_yA = isNaN(newtop) ? Math.round((browserheight - newheight) / 2) : newtop;
		afa_zoom_old = afa_zoom;
		rcarr = [newwidth, newheight, newleft, newtop];
        return rcarr;
    };
    
    jQuery.fn.superbgShowImage = function(img) {
		// if (console && console.log) console.log("call superbgShowImage");
        var options = $.extend($.fn.superbgimage.defaults, $.fn.superbgimage.options);
        $.superbg_imgActual = $(this).attr('rel');
        if (typeof img !== 'undefined') {
            $.superbg_imgActual = img;
        }
        if ($('#' + options.id + ' img.activeslide,video.activeslide').attr('rel') === $.superbg_imgActual) {
            return false;
        }
        if ($.superbg_inAnimation) {
            return false;
        } else {
            $.superbg_inAnimation = true;
        }
        var imgsrc = '';
        var imgtitle = '';
		var isvideo = '';
		var type = '';
        if ($('#' + options.id).children('*' + "[rel='" + $.superbg_imgActual + "']").length === 0) {	//从列表中读src、title等配制
            imgsrc = $('#' + $.superbg_saveId + ' a' + "[rel='" + $.superbg_imgActual + "']").attr('href');
            imgtitle = $('#' + $.superbg_saveId + ' a' + "[rel='" + $.superbg_imgActual + "']").attr('title');
			isvideo = $('#' + $.superbg_saveId + ' a' + "[rel='" + $.superbg_imgActual + "']").attr('isvideo');
			type = $('#' + $.superbg_saveId + ' a' + "[rel='" + $.superbg_imgActual + "']").attr('type');
        } else {	//不知道是什么情况
            imgsrc = $('#' + options.id).children('*' + "[rel='" + $.superbg_imgActual + "']").attr('src');
        }
        if ((typeof options.onHide === 'function') && (options.onHide !== null) && ($.superbg_imgLast >= 0)) {
            options.onHide($.superbg_imgLast);
        }
        $('#' + options.id + ' img.activeslide,video.activeslide').superbgLoadImage(imgsrc, imgtitle, isvideo, type);
        $('#' + $.superbg_saveId + ' a').removeClass('activeslide');
        $('#' + $.superbg_saveId).children('a' + "[rel='" + $.superbg_imgActual + "']").addClass('activeslide');
        $.superbg_imgSlide = $.superbg_imgActual;	//这个计算方法不对，必须要修正，前面有多少个moved，就要减多少
		// for(var i=1;i<$.superbg_imgActual;i++){	//在这里修正是事后诸葛。。，先调用的是NextSlide
			// if($('#thumbs1 a' + "[rel='" + i + "']").hasClass('moved')){
				// $.superbg_imgSlide--;
			// }
		// }
		// if($.superbg_imgSlide < 1){
			// $.superbg_imgSlide = 1
		// }
        $.superbg_imgLast = $.superbg_imgActual;
        return false;
    };
    jQuery.fn.superbgLoadImage = function(imgsrc, imgtitle, isvideo, type) {
		// if (console && console.log) console.log("call superbgLoadImage");
		afa_zoom = 1.0;
		afa_zoom_old = 1.0;
		afa_xA = 0;
		afa_yA = 0;
		afa_imageload = true;
		afa_drag = false;
		afa_dragX = 0;
		afa_dragY = 0;
        var options = $.extend($.fn.superbgimage.defaults, $.fn.superbgimage.options);
        if ($('#' + options.id).children('*' + "[rel='" + $.superbg_imgActual + "']").length === 0) {
            if(isvideo !== 'true') {
				//图片
				var img = new Image();
				$(img).load(function() {
					$(this).css('position', 'absolute').hide();
					if ($('#' + options.id).children('*' + "[rel='" + $.superbg_imgActual + "']").length === 0) {
						$(this).attr('rel', $.superbg_imgActual);
						if (options.showtitle === 1) {
							$(this).attr('title', imgtitle);
						}
						$('#' + options.id).prepend(this);	//插入图片
					}
					var thisimg = $('#' + options.id).children('*' + "[rel='" + $.superbg_imgActual + "']");
					var dimensions = $(this).superbgCalcSize(img.width, img.height);
					if(dimensions != null){
						$(this).superbgTransition(thisimg, dimensions);
					}
					if (!$.superbg_firstLoaded) {
						if (options.slideshow === 1) {
							$(this).startSlideShow();
						}
						if ((options.preload === 1) && ($('#' + $.superbg_saveId).children('a').length > 0)) {
							if ($.superbg_preload !== 0) {
								clearInterval($.superbg_preload);
							}
							$.superbg_preload = setInterval("$(this).superbgimagePreload()", 250);
						}
					}
					$.superbg_firstLoaded = true;
					img.onload = function() {
					};
				}).error(function() {
					$.superbg_inAnimation = false;
					img.onerror = function() {
					};
				}).attr('src', imgsrc);
			} else {
				//视频
				var obj = document.createElement('video');
					
				/* $(obj).load(function() {	//不知为何不起作用 怀疑是jQuery不给video派发load事件
					alert('111111111111111');
					//obj.onload = function() {
					//};
				});
				obj.addEventListener('load', function() {
					alert('22222222222');
					//obj.onload = function() {
					//};
				}, false); */
				$(obj)/* .load(function() {
					$(this).css('position', 'absolute').hide();
					if ($('#' + options.id).children('*' + "[rel='" + $.superbg_imgActual + "']").length === 0) {
						$(this).attr('rel', $.superbg_imgActual);
						if (options.showtitle === 1) {
							$(this).attr('title', imgtitle);
						}
						$(this).attr('name', 'media');
						$(this).attr('controls', '');
						$(this).attr('autoplay', '');
						$(this).attr('loop', '');
						$(this).attr('preload', 'auto');
						
						var source = document.createElement('source');
						$(source).attr('src', 'imgsrc');
						$(source).attr('type', 'video/' + ext);		//to do: 可能要做转换，参考https://developer.mozilla.org/en-US/docs/Web/HTML/Supported_media_formats
						$(this).append(source);
						
						$('#' + options.id).prepend(this);	//插入视频
					}
					var thisimg = $('#' + options.id).children('*' + "[rel='" + $.superbg_imgActual + "']");
					var dimensions = $(this).superbgCalcSize(obj.width, obj.height);
					$(this).superbgTransition(thisimg, dimensions);
					if (!$.superbg_firstLoaded) {
						if (options.slideshow === 1) {
							$(this).startSlideShow();
						}
						if ((options.preload === 1) && ($('#' + $.superbg_saveId).children('a').length > 0)) {
							$.superbg_preload = setInterval("$(this).superbgimagePreload()", 250);
						}
					}
					$.superbg_firstLoaded = true;
					obj.onload = function() {
					};
				}) */.error(function() {
					$.superbg_inAnimation = false;
					obj.onerror = function() {
					};
				})/* .attr('src', imgsrc) */;
				
				$(obj).css('position', 'absolute').hide();
					if ($('#' + options.id).children('*' + "[rel='" + $.superbg_imgActual + "']").length === 0) {
						$(obj).attr('rel', $.superbg_imgActual);
						if (options.showtitle === 1) {
							$(obj).attr('title', imgtitle);
						}
						$(obj).attr('name', 'media');
						$(obj).attr('controls', ' ');
						$(obj).attr('autoplay', ' ');
						$(obj).attr('loop', ' ');
						$(obj).attr('preload', 'auto');
						
						var source = document.createElement('source');
						$(source).attr('src', imgsrc);
						//$(source).attr('type', 'video/' + ext);		//to do: 可能要做转换，参考https://developer.mozilla.org/en-US/docs/Web/HTML/Supported_media_formats
						$(source).attr('type', type);
						$(obj).append(source);
						
						$('#' + options.id).prepend(obj);	//插入视频
					}
					
					obj.onloadedmetadata = function() {
						//alert("Browser has loaded the current frame");
						var thisimg = $('#' + options.id).children('*' + "[rel='" + $.superbg_imgActual + "']");
						var dimensions = $(obj).superbgCalcSize(obj.videoWidth, obj.videoHeight );
						if(dimensions!=null){
							$(obj).superbgTransition(thisimg, dimensions);
						}
						if (!$.superbg_firstLoaded) {
							if (options.slideshow === 1) {
								$(obj).startSlideShow();
							}
							if ((options.preload === 1) && ($('#' + $.superbg_saveId).children('a').length > 0)) {
								if ($.superbg_preload !== 0) {
									clearInterval($.superbg_preload);
								}
								$.superbg_preload = setInterval("$(this).superbgimagePreload()", 250);
							}
						}
						$.superbg_firstLoaded = true;
						
						//修正延迟时间
						if(options.slide_interval <= obj.duration*1000 - options.outspeed){
							if ($.superbg_interval !== 0) {
								clearInterval($.superbg_interval);
							}
							$.superbg_interval = setInterval("$(this).nextSlide()", Math.round(obj.duration*1000 - options.outspeed));
						}
					};
			}
        } else {
            var thisimg = $('#' + options.id).children('*' + "[rel='" + $.superbg_imgActual + "']");
            var dimensions = $(this).superbgCalcSize($(thisimg).width(), $(thisimg).height());
            $(this).superbgTransition(thisimg, dimensions);
			if($('#' + options.id + ' video.activeslide').length !== 0){	//取消静音
				$('#' + options.id + ' video.activeslide')[0].volume = 1;
			}
            if (!$.superbg_firstLoaded) {
                if (options.slideshow === 1) {
                    $(this).startSlideShow();
                }
                if ((options.preload === 1) && ($('#' + $.superbg_saveId).children('a').length > 0)) {
					if ($.superbg_preload !== 0) {
						clearInterval($.superbg_preload);
					}
                    $.superbg_preload = setInterval("$(this).superbgimagePreload()", 250);
                }
                $.superbg_firstLoaded = true;
            }
        }
    };
    jQuery.fn.superbgTransition = function(thisimg, dimensions) {
		// if (console && console.log) console.log("call superbgTransition");
        var options = $.extend($.fn.superbgimage.defaults, $.fn.superbgimage.options);
        var newwidth = dimensions[0];
        var newheight = dimensions[1];
        var newleft = dimensions[2];
        var newtop = dimensions[3];
        $(thisimg).css('width', newwidth + 'px').css('height', newheight + 'px').css('left', newleft + 'px');
        if ((typeof options.onClick === 'function') && (options.onClick !== null)) {
            $(thisimg).unbind('click').click(function() {
                options.onClick($.superbg_imgActual);
            });
        }
        if ((typeof options.onMouseenter === 'function') && (options.onMouseenter !== null)) {
            $(thisimg).unbind('mouseenter').mouseenter(function() {
                options.onMouseenter($.superbg_imgActual);
            });
        }
        if ((typeof options.onMouseleave === 'function') && (options.onMouseleave !== null)) {
            $(thisimg).unbind('mouseleave').mouseleave(function() {
                options.onMouseleave($.superbg_imgActual);
            });
        }
        if ((typeof options.onMousemove === 'function') && (options.onMousemove !== null)) {
            $(thisimg).unbind('mousemove').mousemove(function(e) {
                options.onMousemove($.superbg_imgActual, e);
            });
        }
		// if ((typeof options.onMouseover === 'function') && (options.onMouseover !== null)) {
            // $(thisimg).unbind('mouseover').mousemove(function(e) {
                // options.onMouseover($.superbg_imgActual, e);
            // });
        // }
		if ((typeof options.onMousewheel === 'function') && (options.onMousewheel !== null)) {
            $(thisimg).unbind('mousewheel').mousewheel(function(e) {
                options.onMousewheel($.superbg_imgActual, e);
            });
        }
		if ((typeof options.onMouseup === 'function') && (options.onMouseup !== null)) {
            $(thisimg).unbind('mouseup').mouseup(function(e) {
                options.onMouseup($.superbg_imgActual, e);
            });
        }
		if ((typeof options.onMousedown === 'function') && (options.onMousedown !== null)) {
            $(thisimg).unbind('mousedown').mousedown(function(e) {
                options.onMousedown($.superbg_imgActual, e);
            });
        }
		if ((typeof options.onDragstart === 'function') && (options.onDragstart !== null)) {
            $(thisimg).unbind('dragstart').dragstart(function(e) {
                options.onDragstart($.superbg_imgActual, e);
            });
        }
        if (options.randomtransition === 1) {
            var randomtrans = (0 + parseInt(Math.random() * ($.superbg_max_randomtrans - 0 + 1), 10));
            while (randomtrans === $.superbg_lasttrans) {
                randomtrans = (0 + parseInt(Math.random() * ($.superbg_max_randomtrans - 0 + 1), 10));
            }
            options.transition = randomtrans;
        }
        if (options.vertical_center === 1) {
            $(thisimg).css('top', newtop + 'px');
        } else {
            $(thisimg).css('top', '0px');
        }
        var akt_transitionout = options.transitionout;
        if ((options.transition === 6) || (options.transition === 7)) {
            akt_transitionout = 0;
        }
        if (akt_transitionout === 1) {
			if($('#' + options.id + ' video.activeslide').length !== 0){	//静音
				$('#' + options.id + ' video.activeslide')[0].volume = 0;
			}
            $('#' + options.id + ' img.activeslide,video.activeslide').removeClass('activeslide').addClass('lastslide').css('z-index', 0);
        } else {
			if($('#' + options.id + ' video.activeslide').length !== 0){	//静音
				$('#' + options.id + ' video.activeslide')[0].volume = 0;
			}
            $('#' + options.id + ' img.activeslide,video.activeslide').removeClass('activeslide').addClass('lastslideno').css('z-index', 0);
        }
        $(thisimg).css('z-index', 1);
        options.transition = parseInt(options.transition, 10);
        $.superbg_lasttrans = options.transition;
        var theEffect = '';
        var theDir = '';
        if (options.transition === 0) {
            $(thisimg).show(1, function() {
                if ((typeof options.onShow === 'function') && (options.onShow !== null))
                    options.onShow($.superbg_imgActual);
                $.superbg_inAnimation = false;
                if ($.superbg_slideshowActive) {
                    $('#' + options.id).startSlideShow();
                }
            }).addClass('activeslide');
        } else if (options.transition === 1) {
            $(thisimg).fadeIn(options.speed, function() {
                if ((typeof options.onShow === 'function') && (options.onShow !== null))
                    options.onShow($.superbg_imgActual);
                $('#' + options.id + ' img.lastslideno,video.lastslideno').hide(1, null).removeClass('lastslideno');
                $.superbg_inAnimation = false;
                if ($.superbg_slideshowActive) {
                    $('#' + options.id).startSlideShow();
                }
            }).addClass('activeslide');
        } else {
            if (options.transition === 2) {
                theEffect = 'slide';
                theDir = 'up';
            }
            if (options.transition === 3) {
                theEffect = 'slide';
                theDir = 'right';
            }
            if (options.transition === 4) {
                theEffect = 'slide';
                theDir = 'down';
            }
            if (options.transition === 5) {
                theEffect = 'slide';
                theDir = 'left';
            }
            if (options.transition === 6) {
                theEffect = 'blind';
                theDir = 'horizontal';
            }
            if (options.transition === 7) {
                theEffect = 'blind';
                theDir = 'vertical';
            }
            if (options.transition === 90) {
                theEffect = 'slide';
                theDir = 'left';
                if ($.superbg_direction === 1) {
                    theDir = 'right';
                }
            }
            if (options.transition === 91) {
                theEffect = 'slide';
                theDir = 'down';
                if ($.superbg_direction === 1) {
                    theDir = 'up';
                }
            }
            $(thisimg).show(theEffect, {direction: theDir}, options.speed, function() {
                if ((typeof options.onShow === 'function') && (options.onShow !== null))
                    options.onShow($.superbg_imgActual);
                $('#' + options.id + ' img.lastslideno,video.lastslideno').hide(1, null).removeClass('lastslideno');
                $.superbg_inAnimation = false;
                if ($.superbg_slideshowActive) {
                    $('#' + options.id).startSlideShow();
                }
            }).addClass('activeslide');
        }
        if (akt_transitionout === 1) {
            var outspeed = options.speed;
            if (options.speed == 'slow') {
                outspeed = 600 + 200;
            } else if (options.speed == 'normal') {
                outspeed = 400 + 200;
            } else if (options.speed == 'fast') {
                outspeed = 400 + 200;
            } else {
                outspeed = options.speed + 200;
            }
            if (options.transition === 0) {
                $('#' + options.id + ' img.lastslide,video.lastslide').hide(1, null).removeClass('lastslide');
            } else if (options.transition == 1) {
                $('#' + options.id + ' img.lastslide,video.lastslide').fadeOut(outspeed).removeClass('lastslide');
            } else {
                if (options.transition === 2) {
                    theEffect = 'slide';
                    theDir = 'down';
                }
                if (options.transition === 3) {
                    theEffect = 'slide';
                    theDir = 'left';
                }
                if (options.transition === 4) {
                    theEffect = 'slide';
                    theDir = 'up';
                }
                if (options.transition === 5) {
                    theEffect = 'slide';
                    theDir = 'right';
                }
                if (options.transition === 6) {
                    theEffect = '';
                    theDir = '';
                }
                if (options.transition === 7) {
                    theEffect = '';
                    theDir = '';
                }
                if (options.transition === 90) {
                    theEffect = 'slide';
                    theDir = 'right';
                    if ($.superbg_direction === 1) {
                        theDir = 'left';
                    }
                }
                if (options.transition === 91) {
                    theEffect = 'slide';
                    theDir = 'up';
                    if ($.superbg_direction === 1) {
                        theDir = 'down';
                    }
                }
                $('#' + options.id + ' img.lastslide,video.lastslide').hide(theEffect, {direction: theDir}, outspeed).removeClass('lastslide');
            }
        } else {
            $('#' + options.id + ' img.lastslide,video.lastslide').hide(1, null).removeClass('lastslide');
        }
    };
    jQuery.fn.superbgimage.defaults = {id: 'superbgimage',z_index: 0,inlineMode: 0,showimage: 1,vertical_center: 1,transition: 1,transitionout: 1,randomtransition: 0,showtitle: 0,slideshow: 0,slide_interval: 5000,randomimage: 0,speed: 'slow',preload: 1,onShow: null,onClick: null,onHide: null,onMouseenter: null,onMouseleave: null,onMousemove: null,/* onMouseover: null, */onMousewheel: null,onMouseup: null,onMousedown: null,onMouseleave: null};
})(jQuery);
